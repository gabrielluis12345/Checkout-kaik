<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Checkout - Produto</title>

  <style>
    :root {
      --azul: #1A73E8;
      --azul-claro: #E8F0FE;
      --preto: #1f1f1f;
      --cinza: #6e6e6e;
      --radius: 14px;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #ffffff;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      padding-top: 40px;
    }

    .container {
      width: 100%;
      max-width: 420px;
      background: #fff;
      padding: 25px;
      border-radius: var(--radius);
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      animation: aparecer .4s ease-out;
      position: relative;
    }

    @keyframes aparecer {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo {
      width: 120px;
      margin-bottom: 10px;
      display: block;
    }

    #cancelado {
      display: none;
      text-align: center;
      color: red;
      font-size: 22px;
      margin-bottom: 20px;
    }

    #timer {
      margin-top: 10px;
      font-size: 17px;
      font-weight: bold;
      color: #d00000;
    }

    .copy-btn {
      margin-top: 10px;
      background: var(--azul);
      color: white;
      padding: 10px;
      border-radius: var(--radius);
      cursor: pointer;
      border: none;
      width: 100%;
      font-size: 16px;
    }

    .copy-btn:hover {
      background: #125cc0;
    }
  </style>
</head>
<body>

  <div class="container">

    <div id="cancelado">‚ùå Pagamento Cancelado</div>

    <img src="logo.png" alt="Logo" class="logo">

    <h2>Finalizar Pedido</h2>

    <div class="produto">
      <img src="product.jpg" alt="Produto" width="70">
      <div>
        <div class="produto-title">Rifa do Milh√£o Viva Sorte</div>
        <small>Valor unit√°rio: <b>R$ 0,20</b></small>
      </div>
    </div>

    <div class="qty-box">
      <button onclick="alterar(-1)">‚àí</button>
      <span id="qtd">1</span>
      <button onclick="alterar(1)">+</button>
    </div>

    <span id="total">R$ 0,20</span>

    <form id="form">

      <input type="text" id="nome" placeholder="Nome completo" required>
      <input type="text" id="cpf" placeholder="CPF" required>
      <input type="email" id="email" placeholder="E-mail" required>
      <input type="date" id="nascimento" required>
      <input type="text" id="telefone" placeholder="Telefone" required>

      <button class="pagar" type="submit">Pagar com PIX</button>
    </form>

    <div id="pixArea" style="display:none; text-align:center;">
      <h3>Escaneie o QR Code</h3>
      <img id="pixImg" width="240">
      <p id="pixCopy" style="word-break: break-all;"></p>

      <button class="copy-btn" onclick="copiarPix()">Copiar c√≥digo PIX</button>

      <p id="timer">Tempo restante: 10:00</p>
      <p style="color: var(--cinza);">Aguardando pagamento...</p>
    </div>
  </div>

<script>
  // üîµ EVITAR BACK ‚Üí MOSTRAR TELA DE CANCELAMENTO
  if (performance.navigation.type === 2) {
    document.getElementById("cancelado").style.display = "block";
    document.getElementById("form").style.display = "none";
  }

  let qtd = 1;

  function alterar(v) {
    qtd += v;
    if (qtd < 1) qtd = 1;
    document.getElementById("qtd").innerText = qtd;
    document.getElementById("total").innerText = "R$ " + (qtd * 0.20).toFixed(2);
  }

  document.getElementById("form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const body = {
      nome: nome.value,
      cpf: cpf.value,
      email: email.value,
      nascimento: nascimento.value,
      telefone: telefone.value,
      quantidade: qtd,
      valor: (qtd * 0.20).toFixed(2)
    };

    const req = await fetch("/criar-pagamento", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(body)
    });

    const res = await req.json();

    if (res.erro) {
      alert("Erro ao gerar PIX");
      return;
    }

    document.getElementById("pixImg").src = "data:image/png;base64," + res.qr;
    document.getElementById("pixCopy").innerText = res.code;

    document.getElementById("pixArea").style.display = "block";
    document.getElementById("form").style.display = "none";

    iniciarTimer();
    verificar(res.id);
  });

  // üîµ BOT√ÉO COPIAR PIX
  function copiarPix() {
    navigator.clipboard.writeText(document.getElementById("pixCopy").innerText);
    alert("C√≥digo PIX copiado!");
  }

  // üîµ TIMER 10 minutos
  let timeLeft = 600; // 10 min

  function iniciarTimer() {
    const t = setInterval(() => {
      timeLeft--;

      let m = String(Math.floor(timeLeft / 60)).padStart(2, "0");
      let s = String(timeLeft % 60).padStart(2, "0");

      document.getElementById("timer").innerText = `Tempo restante: ${m}:${s}`;

      if (timeLeft <= 0) {
        clearInterval(t);
        alert("‚ö† O tempo expirou! O pagamento foi cancelado.");
        window.location.href = "/"; 
      }
    }, 1000);
  }

  // üîµ VERIFICAR PAGAMENTO
  async function verificar(id) {
    const loop = setInterval(async () => {
      const r = await fetch(`/verificar/${id}`);
      const data = await r.json();

      if (data.status === "approved") {
        clearInterval(loop);
        window.location.href = "/sucesso.html";
      }
    }, 4000);
  }
</script>

</body>
</html>
